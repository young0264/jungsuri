<!DOCTYPE html>
<html
        lang="kr"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:sec="http://thymeleaf.org/extras/spring-security"
        xmlns="http://www.w3.org/1999/xhtml"
>

<script th:inline="javascript">
    var accountId = /*[[${accountEntity.id}]]*/;
    var postId = /*[[${postEntity.id}]]*/;
    console.log("accountId : ", accountId);
    console.log("postId : ", postId);

    /** 화면이 새로고침 될 때, 이미 like를 누른 댓글은 표시*/
    document.addEventListener('DOMContentLoaded', function() {
        loadCommentLikes(accountId, postId);
        loadPostLikes(accountId, postId);
    });
    /** 현재 게시물에 좋아요를 눌렀는지, 표시*/
    function loadPostLikes(accountId, postId) {
        fetch('/like/post?accountId='+accountId+'&postId='+postId, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'},
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const heartIcon = document.getElementById("heart");
                if (data === true) {
                    heartIcon.classList.add("fas");
                    heartIcon.classList.remove("far");
                    heartIcon.style.color = "red";
                } else {
                    heartIcon.classList.add("far");
                    heartIcon.classList.remove("fas");
                    heartIcon.style.color = "";
                }
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
    }

    /**이 게시물에 해당하는 댓글에 좋아요를 눌렀으면, 누른 댓글 id만 가져와서 표시해주기.*/
    function loadCommentLikes(accountId, postId) {
        fetch('/like/comment?accountId='+accountId+'&postId='+postId, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'},
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                for (let i = 0; i < data.length; i++) {
                    const commentId = data[i];
                    const heartIcon = document.getElementById("heart_comment_"+commentId);
                    heartIcon.classList.add("fas");
                    heartIcon.classList.remove("far");
                    heartIcon.style.color = "red";
                }
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });

    }

    /**
     * comment를 받아서 textarea 에 넣어주는 함수
     */
    let commentContent = null;
    let commentIdValue = null;

    /** 댓글 기능(th라서 빛이 안들어옴) */
    let comment = {

        showUpdateModal: function (content, commentIdParam) {
            commentContent = content;
            commentIdValue = commentIdParam;
            document.getElementById("modal-comment-content").value = content;
        },

        update: function () {

            //fetch 시작
            const comment = document.getElementById("modal-comment-content").value;
            const commentId = commentIdValue;
            const data = {
                "commentId": commentId,
                "newComment": comment,
            };

            fetch('/comment', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    alert('성공적으로 수정되었습니다.');
                    $('#CommentUpdateModal').modal('hide'); // 모달 닫기
                    window.location.reload(); // 페이지 새로고침
                })
                .catch(error => {
                    console.error('comment update fetch error:', error.message);
                });
        },

        delete: function (commentIdParam, postIdParam) {
            alert(commentIdParam);
            const data = {
                "commentId": commentIdParam,
                "postId": postIdParam,
            }
            fetch('/comment', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    alert('성공적으로 삭제되었습니다..');
                    $('#CommentUpdateModal').modal('hide'); // 모달 닫기
                    window.location.reload(); // 페이지 새로고침
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        },
    }

    /** 좋아요 기능 */
    let like = {
        modifyPostLike: function (accountId, postId) {
            let data = {
                accountId: accountId,
                postId: postId
            };
            fetch('/like/post',{
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(
                response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(
                    data => {
                        document.getElementById("post_like_count").innerText = data['likeCount'];
                        const heartIcon = document.getElementById("heart");
                        if (data['like'] === true) {
                            heartIcon.classList.add("fas");
                            heartIcon.classList.remove("far");
                            heartIcon.style.color = "red";
                        } else {
                            heartIcon.classList.add("far");
                            heartIcon.classList.remove("fas");
                            heartIcon.style.color = "";
                        }
                    }
                )
                .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                    }
                )
        },

        modifyCommentLike: function (accountId, postId, commentId){
            let data = {
                accountId: accountId,
                postId: postId,
                commentId: commentId
            };
            fetch('/like/comment',{
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(
                response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(
                    data => {
                        document.getElementById("comment_like_count_"+commentId).innerText = data['likeCount'];
                        const heartIcon = document.getElementById("heart_comment_"+commentId);
                        if (data['like'] === true) {
                            heartIcon.classList.add("fas");
                            heartIcon.classList.remove("far");
                            heartIcon.style.color = "red";
                        } else {
                            heartIcon.classList.add("far");
                            heartIcon.classList.remove("fas");
                            heartIcon.style.color = "";
                        }
                    }
                )
                .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                    }
                )

        }
    }
</script>

<span th:replace="~{fragments/fragments.html :: head}"></span>

<head th:replace="~{fragments/fragments.html :: nav_header}"></head>

<body data-spy="scroll" data-target=".onpage-navigation" data-offset="60">
<section class="module">
    <div class="container">

        <div class="row">
            <!-- left slider start col-sm-4-->
            <span th:replace="fragments/fragments.html :: left_sidebar"></span>
            <!-- left slider end col-sm-4-->

            <!-- post details start -->
            <div class="col-sm-8 col-sm-offset-1">
                <!-- 게시글  start-->
                <div class="post" th:object="${postEntity}">
                    <div class="post-thumbnail"><img src="/static/images/jungsuri_logo.png" alt="Blog Featured Image"/>
                    </div>
                    <div class="post-header font-alt">
                        <h1 class="post-title" th:text="${postEntity.title}"></h1>
                        <div class="post-meta">By&nbsp;<a href="#" th:text="${postEntity.author}"></a>| 23 November | 3
                            Comments | <a
                                    href="#">Photography, </a><a href="#">Web Design</a>
                        </div>
                    </div>
                    <div class="post-entry " style="height: 300px">
                        <h4 th:utext="${postEntity.content}"></h4>
                    </div>
                </div>
                <!-- 게시글  end-->
                <!-- 댓글 list start-->
                <hr>
                <div class="post-meta-wrap">
                    <a id="heart" class="far fa-heart" style="font-size: 20px; " th:onclick="like.modifyPostLike(/*[[${accountEntity.getId()}]]*/ , /*[[${postEntity.getId()}]]*/)"> 좋아요 <span id="post_like_count" th:text="${postEntity.likeCount}"></span>개 </a>
                </div>
                <hr>
                <h4 class="comment-title ">There are <span th:text="${postEntity.commentCount}"></span> comments</h4>

                <div class="comment clearfix" th:each="comment : ${commentList}">
                    <div class="comment-avatar"><img
                            src="https://s3.amazonaws.com/uifaces/faces/twitter/ryanbattles/128.jpg"
                            alt="avatar"/></div>
                    <div class="comment-content clearfix">
                        <div class="comment-author font-alt">
                            <a href="#" th:text="${comment.author}"></a>
                            <!--                            <a id="heart_comment" class="far fa-heart" style="font-size: 15px; "-->
                            <a  th:id="'heart_comment_' + ${comment.id}" class="far fa-heart" style="font-size: 15px; "
                                th:onclick="like.modifyCommentLike(/*[[${accountEntity.getId()}]]*/, /*[[${postEntity.id}]]*/ , /*[[${comment .getId()}]]*/)">
                                좋아요
                                <span th:id="'comment_like_count_' + ${comment.id}" th:text="${comment.likeCount}"></span>개 </a>
                        </div>
                        <div class="comment-body">
                            <p th:text="${comment.content}"></p>
                        </div>
                        <div class="comment-meta font-alt">

                            <!--                            <a href="#" th:text="${comment.createdAt.toLocalDate()}">시간</a>-->
                            <a href="#" th:text="${comment.createdAt.toLocalDate()}">시간</a>
                            <a class="1" href="#">Reply</a>
                            <button type="button" class="btn btn-g btn-round" data-toggle="modal"
                                    data-target="#CommentUpdateModal"
                                    th:onclick="comment.showUpdateModal(/*[[${comment.content}]]*/ , /*[[${comment.id}]]*/)">수정
                            </button>
                            <button type="button" class="btn btn-danger btn-round" th:onclick="comment.delete(/*[[${comment.id}]]*/, /*[[${postId}]]*/)">삭제</button>

                        </div>
                    </div>
                </div>

                <!--                댓글 수정 모달 start-->
                <div class="modal fade" id="CommentUpdateModal" tabindex="-1" role="dialog"
                     aria-labelledby="myModalLabel">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">댓글 수정</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form>
                                    <div class="form-group">
                                        <label for="modal-comment-content" class="col-form-label">댓글 </label>
                                        <textarea class="form-control" id="modal-comment-content"
                                                  name="newComment"></textarea>
                                        <input type="hidden" name="commentId" value="${comment">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="comment.update()">댓글 수정</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!--                댓글 수정 모달 end -->
                <!-- 댓글 list end-->

                <!-- 댓글 작성 start -->
                <h4 class="comment-form-title font-alt">Add your comment</h4>
                <form method="post" th:action="@{/comment}" th:object="${commentCreateDto}">
                    <div class="form-group">
                        <textarea class="form-control" th:field="*{content}" rows="4" placeholder="Comment" required th:min="5" th:max="50"></textarea>
                        <input type="hidden" th:name="loginId" th:value="${accountEntity.loginId}">
                        <input type="hidden" th:name="postId" th:value="${postId}">
                    </div>
                    <div class="text-center " th:if="${comment_create_error}">
                        <div class="alert alert-danger" role="alert">
                            <strong>댓글 등록 실패</strong> <br>
                            <span th:text="${comment_create_error}"></span>
                        </div>
                    </div>
                    <button class="btn btn-round btn-d" type="submit">댓글 등록</button>
                </form>
                <!-- 댓글 작성 end -->
            </div>
            <!-- post details end -->
        </div>
    </div>
</section>
</body>
<div th:replace="~{fragments/fragments.html :: nav_footer}"></div>
<!--  modal  -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.min.js"></script>

</html>